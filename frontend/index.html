<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EzGest SaaS - Professional Analytics</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --p: #2563eb; --p-dark: #1d4ed8; --d: #e11d48; --s: #10b981; --bg: #f1f5f9; --text: #0f172a; --border: #e2e8f0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; overscroll-behavior-y: none; font-size: 14px; line-height: 1.5; height: 100dvh; }
        #app { height: 100%; display: flex; flex-direction: column; }
        #view-dashboard { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #view-login, #view-selection { overflow-y: auto; flex: 1; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid var(--border); margin-bottom: 20px; }
        
        /* Navbar */
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid var(--border); padding: 0 20px; gap: 20px; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.02); flex-shrink: 0; }
        .tab { padding: 16px 10px; cursor: pointer; font-weight: 600; color: #64748b; border-bottom: 2px solid transparent; transition: color 0.2s; font-size: 0.9rem; }
        .tab.active { color: var(--p); border-bottom-color: var(--p); }

        /* POS UI */
        .category-slider { display: flex; overflow-x: auto; gap: 8px; padding: 12px 20px; background: #fff; border-bottom: 1px solid var(--border); scrollbar-width: none; }
        .cat-pill { flex: 0 0 auto; padding: 8px 16px; border-radius: 99px; background: #f8fafc; border: 1px solid var(--border); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; color: #475569; }
        .cat-pill:hover { background: #f1f5f9; border-color: #cbd5e1; }
        .cat-pill.active { background: var(--p); color: white; border-color: var(--p); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }

        .tab-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        #sub-pos { height: 100%; }
        #sub-gest, #sub-repo { overflow-y: auto; height: 100%; }

        .pos-container { display: grid; grid-template-columns: 1fr 380px; flex: 1; min-height: 0; background: #f8fafc; }
        .products-area { overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; align-content: start; }
        .product-card { background: white; border: 1px solid var(--border); padding: 15px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; justify-content: space-between; height: 100%; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .product-card:hover { transform: translateY(-2px); border-color: var(--p); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .product-card strong { display: block; margin: 5px 0; font-size: 0.95rem; color: #334155; }
        
        .cart-panel { background: white; border-left: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; box-shadow: -2px 0 10px rgba(0,0,0,0.03); }
        .cart-items { flex: 1; overflow-y: auto; padding: 15px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        .cart-total { padding: 20px; background: #f8fafc; border-top: 1px solid var(--border); }
        
        .cart-header-mobile { display: none; }
        .cart-header-desktop { padding: 15px; font-weight: bold; border-bottom: 1px solid #eee; }

        /* Report UI */
        .report-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; padding: 20px; }
        .chart-box { position: relative; height: 300px; }
        
        /* Filter Toggle Defaults (Desktop) */
        #report-filters-body { display: block; margin-top: 15px; }
        .filter-toggle-icon { display: none; }

        /* Common */
        button { cursor: pointer; padding: 10px 16px; border-radius: 8px; border: none; font-weight: 600; color: white; background: var(--p); transition: all 0.2s; font-size: 0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        button:hover { background: var(--p-dark); transform: translateY(-1px); }
        button:active { transform: translateY(0); }
        .btn-grey { background: #64748b; } .btn-grey:hover { background: #475569; }
        .btn-red { background: var(--d); } .btn-red:hover { background: #be123c; }
        .btn-save { background: var(--s); } .btn-save:hover { background: #059669; }
        .btn-edit { background: #f59e0b; padding: 5px 10px; font-size: 12px; }
        
        input, select { padding: 10px 12px; border: 1px solid #cbd5e1; border-radius: 8px; width: 100%; margin-bottom: 12px; box-sizing: border-box; font-family: inherit; transition: all 0.2s; background: #fff; }
        input:focus, select:focus { outline: none; border-color: var(--p); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; padding: 12px; border-bottom: 1px solid var(--border); text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; color: #334155; }
        td .btn-edit, td .btn-red { margin-left: 5px; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f8fafc; }

        /* Mobile / WAP Optimization */
        .gest-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; }
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        @media (max-width: 768px) {
            /* POS Mobile Layout - Bottom Sheet Approach */
            .pos-container { display: flex; flex-direction: column; height: 100%; position: relative; overflow: hidden; }
            .products-area { flex: 1; padding: 15px; grid-template-columns: repeat(auto-fill, minmax(105px, 1fr)); gap: 12px; overflow-y: auto; padding-bottom: 80px; }
            .product-card { padding: 10px; }
            
            .cart-panel { 
                position: absolute; bottom: 0; left: 0; right: 0; height: 85%; z-index: 100;
                border-radius: 20px 20px 0 0; box-shadow: 0 -5px 25px rgba(0,0,0,0.2);
                transform: translateY(calc(100% - 60px)); transition: transform 0.3s cubic-bezier(0.3, 0, 0, 1);
                border: none; padding-bottom: env(safe-area-inset-bottom);
            }
            .cart-panel.open { transform: translateY(0); }
            .cart-header-mobile { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; height: 60px; background: var(--p); color: white; border-radius: 20px 20px 0 0; cursor: pointer; font-weight: 600; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
            .cart-header-desktop { display: none; }
            .cart-total { padding: 15px; }

            /* Vertical Stack Layouts */
            .report-grid:not(.hidden) { 
                display: flex !important; flex-direction: column !important; overflow-x: hidden; overflow-y: auto !important; 
                gap: 15px; padding: 15px; height: 100% !important; align-items: stretch;
            }

            /* Gestione: Horizontal Swipe */
            .gest-grid:not(.hidden) {
                display: flex !important; flex-direction: row !important; overflow-x: auto !important; overflow-y: hidden !important;
                scroll-snap-type: x mandatory; gap: 15px; padding: 15px; height: 100% !important; align-items: stretch;
            }

            .charts-row, .mobile-swipe-col {
                display: flex !important; flex-direction: column !important; height: auto; gap: 15px;
            }
            
            .report-grid > .card, .charts-row > .card, .mobile-swipe-col > .card { 
                min-width: 0; width: 100%; max-height: none; overflow: visible; margin-bottom: 0;
            }
            .gest-grid > .card { min-width: 90vw; width: 90vw; scroll-snap-align: center; overflow-y: auto; margin-bottom: 0; }
            
            /* Table Fixes for Mobile */
            .card { overflow-x: auto; }
            table { min-width: 100%; }
            th, td { padding: 10px 5px; font-size: 13px; }
            input, select { font-size: 16px; } /* Prevent iOS Zoom */
            
            .nav-tabs { gap: 0; justify-content: space-between; }
            .tab { flex: 1; text-align: center; padding: 15px 5px; font-size: 13px; border-width: 3px; }

            /* Report Filters Mobile Toggle */
            #report-filters-body { display: none; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
            #report-filters-body.open { display: block; }
            .filter-toggle-icon { display: block; transform: rotate(0deg); transition: transform 0.3s; font-size: 1.2rem; color: var(--p); }
            .filter-toggle-icon.open { transform: rotate(180deg); }
        }
    </style>
</head>
<body>

<div id="app">
    <div id="view-login" class="card" style="max-width: 350px; margin: 100px auto; text-align: center;">
        <h2 style="color:var(--p)">EzGest SaaS</h2>
        <input type="text" id="uIn" placeholder="Username">
        <input type="password" id="pIn" placeholder="Password">
        <button onclick="doLogin()" style="width:100%">Accedi</button>
    </div>

    <div id="view-selection" class="hidden" style="padding: 40px;">
        <div class="card" style="max-width: 800px; margin: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                <h2>Le tue Attivit√†</h2>
                <button class="btn-grey" onclick="doLogout()">Esci</button>
            </div>
            <div id="list-companies" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:20px;"></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; border-top:1px solid #eee; padding-top:20px">
                <div><h4>Crea</h4><input id="newCo" placeholder="Nome Attivit√†"><button onclick="doCreateCo()">Crea</button></div>
                <div><h4>Unisciti</h4><input id="joinCode" placeholder="Codice Invito"><button class="btn-grey" onclick="doJoinCo()">Unisciti</button></div>
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="hidden">
        <div style="background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; flex-shrink: 0;">
            <div><b id="activeCoName"></b> <small id="activeCoCode" style="color:var(--p); margin-left:10px"></small></div>
            <button class="btn-grey" style="padding:5px 10px" onclick="showSelection()">Cambia Azienda</button>
        </div>

        <div class="nav-tabs">
            <div class="tab active" id="tab-pos" onclick="switchTab('pos')">üõí SCONTRINO</div>
            <div class="tab" id="tab-gest" onclick="switchTab('gest')">‚öôÔ∏è GESTIONE</div>
            <div class="tab" id="tab-repo" onclick="switchTab('repo')">üìä REPORT</div>
        </div>

        <div id="sub-pos" class="tab-content">
            <div class="category-slider" id="pos-cat-bar"></div>
            <div class="pos-container">
                <div class="products-area" id="pos-products"></div>
                <div class="cart-panel" id="mobile-cart">
                    <div class="cart-header-mobile" onclick="toggleCart()">
                        <span>üõí Carrello <small id="cart-count-badge">(0)</small></span>
                        <span id="cart-preview-total">0.00‚Ç¨</span>
                    </div>
                    <div class="cart-header-desktop">Carrello</div>
                    <div class="cart-items" id="cart-list"></div>
                    <div class="cart-total">
                        <div style="display:flex; justify-content:space-between; font-size:22px; font-weight:800; margin-bottom:15px">
                            <span>TOTALE</span><span><span id="cart-sum">0.00</span>‚Ç¨</span>
                        </div>
                        <button class="btn-save" onclick="processSale()" style="width:100%; padding:15px; font-size:18px">CHIUDI SCONTRINO</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sub-gest" class="tab-content hidden gest-grid">
            <div class="card">
                <h3>üìÇ Categorie</h3>
                <div style="display:flex; gap:5px"><input id="inCat" placeholder="Nome"><button onclick="addCat()">+</button></div>
                <table id="tCats"></table>
            </div>
            <div class="card">
                <h3>üì¶ Prodotti</h3>
                <input id="inPN" placeholder="Nome"><input id="inPP" type="number" placeholder="Prezzo"><select id="selPC"></select>
                <button onclick="addProd()" style="width:100%">Salva</button>
                <table id="tProds"></table>
            </div>
        </div>

        <div id="sub-repo" class="tab-content hidden report-grid">
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; cursor:pointer" onclick="toggleReportFilters()">
                    <h4 style="margin:0">Filtri Analisi</h4>
                    <span class="filter-toggle-icon">‚ñº</span>
                </div>
                <div id="report-filters-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-bottom: 10px;">
                        <button class="btn-grey" style="font-size: 11px; padding: 5px;" onclick="setRange('today')">Oggi</button>
                        <button class="btn-grey" style="font-size: 11px; padding: 5px;" onclick="setRange('7d')">7 Giorni</button>
                        <button class="btn-grey" style="font-size: 11px; padding: 5px;" onclick="setRange('1m')">1 Mese</button>
                        <button class="btn-grey" style="font-size: 11px; padding: 5px;" onclick="setRange('3m')">3 Mesi</button>
                    </div>
                    <label><small>Dal:</small></label><input type="date" id="repFrom" onchange="applyReports()">
                    <label><small>Al:</small></label><input type="date" id="repTo" onchange="applyReports()">
                    
                    <hr style="margin:15px 0; opacity:0.1">
                    <label><small>Filtra Categoria:</small></label>
                    <select id="repSelC" onchange="updateProductFilter()"></select>

                    <label><small>Filtra Prodotto:</small></label>
                    <select id="repSelP" onchange="applyReports()"></select>
                    
                    <hr style="margin:15px 0; opacity:0.1">
                    <p>Incasso: <b id="stat-total" style="color:var(--s); font-size:1.2rem">0.00‚Ç¨</b></p>
                    <p>Scontrini: <b id="stat-count">0</b></p>
                    <p>Top Prodotto: <br><b id="stat-top" style="color:var(--p)">-</b></p>
                </div>
            </div>
            <div class="mobile-swipe-col" style="display:flex; flex-direction:column; gap:20px">
                <div class="card"><h3>üìà Trend Vendite</h3><div class="chart-box"><canvas id="chartTrend"></canvas></div></div>
                <div class="charts-row">
                    <div class="card"><h3>üïí Heatmap Oraria</h3><div class="chart-box"><canvas id="chartHour"></canvas></div></div>
                    <div class="card"><h3>üè∑Ô∏è Distribuzione</h3><div class="chart-box"><canvas id="chartCat"></canvas></div></div>
                </div>
                <div class="card">
                    <h3>üèÜ Classifica Prodotti</h3>
                    <table id="tTopProds"><thead><tr><th>Prodotto</th><th>Quantit√†</th><th>Ricavo</th></tr></thead><tbody></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8787/api';
    let currentId = null, cart = [], allCats = [], allProducts = [], allSales = [], activeCatFilter = 'TUTTI', charts = {};
    const COLORS = ['#2563eb', '#10b981', '#f59e0b', '#e11d48', '#8b5cf6', '#06b6d4', '#f43f5e', '#ec4899'];

    function navigate(id) {
        document.querySelectorAll('#app > div').forEach(d => d.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById('tab-'+tab).classList.add('active');
        document.getElementById('sub-'+tab).classList.remove('hidden');
        if(tab === 'repo') loadReports(); else refresh();
    }

    // --- POS & CORE (Invariati) ---
    function filterPos(cat) { activeCatFilter = cat; renderPosCategories(); renderPosProducts(); }
    function renderPosCategories() {
        const cats = ['TUTTI', ...allCats.map(c => c.nome)];
        document.getElementById('pos-cat-bar').innerHTML = cats.map(c => `<div class="cat-pill ${activeCatFilter === c ? 'active' : ''}" onclick="filterPos('${c}')">${c.toUpperCase()}</div>`).join('');
    }
    function renderPosProducts() {
        const filtered = activeCatFilter === 'TUTTI' ? allProducts : allProducts.filter(p => p.categoria === activeCatFilter);
        document.getElementById('pos-products').innerHTML = filtered.map(p => `<div class="product-card" onclick='addToCart(${JSON.stringify(p)})'><small>${p.categoria}</small><br><strong>${p.nome}</strong><br><b style="color:var(--p)">${parseFloat(p.prezzo).toFixed(2)}‚Ç¨</b></div>`).join('');
    }
    function addToCart(p) { cart.push({...p}); renderCart(); }
    function renderCart() {
        document.getElementById('cart-list').innerHTML = cart.map((item, i) => `<div class="cart-item"><span>${item.nome}</span><span>${parseFloat(item.prezzo).toFixed(2)}‚Ç¨ <button onclick="cart.splice(${i},1);renderCart()" style="background:none;color:red;padding:0;cursor:pointer">‚úï</button></span></div>`).join('');
        const total = cart.reduce((sum, item) => sum + parseFloat(item.prezzo), 0);
        document.getElementById('cart-sum').innerText = total.toFixed(2);
        if(document.getElementById('cart-preview-total')) document.getElementById('cart-preview-total').innerText = total.toFixed(2) + '‚Ç¨';
        if(document.getElementById('cart-count-badge')) document.getElementById('cart-count-badge').innerText = `(${cart.length})`;
    }
    async function processSale() {
        if(!cart.length) return alert("Carrello vuoto");
        await fetch(`${API}/vendite?companyId=${currentId}`, { method: 'POST', body: JSON.stringify({ items: cart, total: document.getElementById('cart-sum').innerText }) });
        alert("Scontrino Chiuso!"); cart = []; renderCart();
    }

    // --- REPORT CON ORDINAMENTO CRONOLOGICO COMPLETO ---
    async function loadReports() {
        const res = await fetch(`${API}/vendite?companyId=${currentId}`);
        allSales = await res.json();
        const cNames = [...new Set(allCats.map(c => c.nome))];
        document.getElementById('repSelC').innerHTML = '<option value="TUTTI">Tutte le categorie</option>' + cNames.map(n => `<option value="${n}">${n}</option>`).join('');
        updateProductFilter();
    }

    function updateProductFilter() {
        const selC = document.getElementById('repSelC').value;
        const filteredProducts = selC === 'TUTTI' ? allProducts : allProducts.filter(p => p.categoria === selC);
        const pNames = [...new Set(filteredProducts.map(p => p.nome))];
        document.getElementById('repSelP').innerHTML = '<option value="TUTTI">Tutti i prodotti</option>' + pNames.map(n => `<option value="${n}">${n}</option>`).join('');
        applyReports();
    }

    function setRange(mode) {
        const to = new Date(); let from = new Date();
        if(mode === '7d') from.setDate(to.getDate() - 7);
        else if(mode === '1m') from.setMonth(to.getMonth() - 1);
        else if(mode === '3m') from.setMonth(to.getMonth() - 3);
        else if(mode === 'today') from = new Date();
        document.getElementById('repFrom').value = from.toISOString().split('T')[0];
        document.getElementById('repTo').value = to.toISOString().split('T')[0];
        applyReports();
    }

    function applyReports() {
        const from = document.getElementById('repFrom').value, to = document.getElementById('repTo').value, 
              selC = document.getElementById('repSelC').value, selP = document.getElementById('repSelP').value;
        
        let filtered = allSales.filter(s => {
            const d = new Date(s.createdAt).toISOString().split('T')[0];
            return (!from || d >= from) && (!to || d <= to);
        });

        let total = 0, hours = Array(24).fill(0), catsMap = {}, prodsMap = {}, dailyTotal = {}, dailyProdSplit = {};
        let allDatesSet = new Set();

        filtered.forEach(s => {
            let sTotal = 0; let saleValid = false;
            // USO ISO DATE PER ORDINAMENTO SICURO (YYYY-MM-DD)
            const dateKey = new Date(s.createdAt).toISOString().split('T')[0];

            s.items.forEach(i => {
                const matchC = (selC === 'TUTTI' || i.categoria === selC);
                const matchP = (selP === 'TUTTI' || i.nome === selP);
                if(matchC && matchP) {
                    saleValid = true; const val = parseFloat(i.prezzo); sTotal += val;
                    allDatesSet.add(dateKey);
                    catsMap[i.categoria] = (catsMap[i.categoria] || 0) + val;
                    if(!prodsMap[i.nome]) prodsMap[i.nome] = { q: 0, t: 0 };
                    prodsMap[i.nome].q++; prodsMap[i.nome].t += val;
                    if(!dailyProdSplit[i.nome]) dailyProdSplit[i.nome] = {};
                    dailyProdSplit[i.nome][dateKey] = (dailyProdSplit[i.nome][dateKey] || 0) + val;
                }
            });

            if(saleValid) {
                total += sTotal;
                dailyTotal[dateKey] = (dailyTotal[dateKey] || 0) + sTotal;
                hours[new Date(s.createdAt).getHours()]++;
            }
        });

        // ORDINAMENTO CRONOLOGICO (Dalla pi√π vecchia alla pi√π recente)
        const sortedDates = Array.from(allDatesSet).sort();
        
        // ETICHETTE LEGGIBILI PER IL GRAFICO (es. 05 feb)
        const labels = sortedDates.map(d => new Date(d).toLocaleDateString('it-IT', {day:'2-digit', month:'short'}));

        let trendDatasets = [];
        if (selC !== 'TUTTI' && selP === 'TUTTI') {
            Object.keys(dailyProdSplit).forEach((pName, idx) => {
                trendDatasets.push({
                    label: pName,
                    data: sortedDates.map(d => dailyProdSplit[pName][d] || 0),
                    borderColor: COLORS[idx % COLORS.length],
                    backgroundColor: COLORS[idx % COLORS.length] + '22',
                    fill: false, tension: 0.4
                });
            });
        } else {
            trendDatasets.push({
                label: selP === 'TUTTI' ? 'Fatturato Totale' : selP,
                data: sortedDates.map(d => dailyTotal[d] || 0),
                borderColor: COLORS[0],
                backgroundColor: COLORS[0] + '22',
                fill: true, tension: 0.4
            });
        }

        document.getElementById('stat-total').innerText = total.toFixed(2) + "‚Ç¨";
        document.getElementById('stat-count').innerText = Object.values(hours).reduce((a,b)=>a+b, 0);
        const sortedProds = Object.entries(prodsMap).sort((a,b) => b[1].q - a[1].q);
        document.getElementById('stat-top').innerText = sortedProds[0] ? `${sortedProds[0][0]} (${sortedProds[0][1].q} pz)` : "-";
        
        updateMultiChart('chartTrend', 'line', labels, trendDatasets);
        updateChart('chartHour', 'bar', Array.from({length:24},(_,i)=>i+":00"), hours, 'Scontrini', '#10b981');

        let pL, pD, pT;
        if(selC === 'TUTTI') { pL = Object.keys(catsMap); pD = Object.values(catsMap); pT = 'Mix Categorie'; }
        else { pL = Object.keys(prodsMap); pD = Object.values(prodsMap).map(x => x.t); pT = `Prodotti in ${selC}`; }
        updateChart('chartCat', 'doughnut', pL, pD, pT);

        document.querySelector('#tTopProds tbody').innerHTML = sortedProds.slice(0,5).map(([n, d]) => `<tr><td>${n}</td><td>${d.q}</td><td>${d.t.toFixed(2)}‚Ç¨</td></tr>`).join('');
    }

    function updateMultiChart(id, type, labels, datasets) {
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(document.getElementById(id), {
            type, data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: true, position: 'top', labels: { usePointStyle: true, boxWidth: 6, font:{family:'Inter'} } } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } }
        });
    }

    function updateChart(id, type, labels, data, label, color = '#2563eb') {
        if(charts[id]) charts[id].destroy();
        const ctx = document.getElementById(id).getContext('2d');
        let background = color;
        if (type === 'bar') {
            const g = ctx.createLinearGradient(0, 0, 0, 250); g.addColorStop(0, color + 'cc'); g.addColorStop(1, color + '22'); background = g;
        } else if (type === 'doughnut') { background = COLORS; }
        charts[id] = new Chart(ctx, {
            type, data: { labels, datasets: [{ label, data, backgroundColor: background, borderColor: type === 'doughnut' ? '#fff' : color, borderWidth: 1, borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'doughnut', position: 'bottom' } }, scales: type === 'doughnut' ? {} : { y: { beginAtZero: true }, x: { grid: { display: false } } } }
        });
    }

    // --- REFRESH & LOGIN ---
    async function refresh() {
        if(!currentId) return;
        const [rc, rp] = await Promise.all([fetch(`${API}/categorie?companyId=${currentId}`), fetch(`${API}/prodotti?companyId=${currentId}`)]);
        allCats = await rc.json(); allProducts = await rp.json();
        document.getElementById('tCats').innerHTML = allCats.map(c => `<tr id="row-cat-${c._id}"><td>${c.nome}</td><td style="text-align:right"><button class="btn-edit" onclick="editCatRow('${c._id}','${c.nome}')">‚úèÔ∏è</button> <button class="btn-red" style="padding:5px 8px" onclick="delItem('categorie','${c._id}')">üóëÔ∏è</button></td></tr>`).join('');
        document.getElementById('selPC').innerHTML = allCats.map(c => `<option value="${c.nome}">${c.nome}</option>`).join('');
        document.getElementById('tProds').innerHTML = allProducts.map(p => `<tr id="row-prod-${p._id}"><td><strong>${p.nome}</strong><br><small>${p.categoria}</small></td><td>${p.prezzo}‚Ç¨</td><td style="text-align:right"><button class="btn-edit" onclick="editProdRow('${p._id}','${p.nome}',${p.prezzo},'${p.categoria}')">‚úèÔ∏è</button> <button class="btn-red" style="padding:5px 8px" onclick="delItem('prodotti','${p._id}')">üóëÔ∏è</button></td></tr>`).join('');
        renderPosCategories(); renderPosProducts();
    }
    async function doLogin() {
        const res = await fetch(`${API}/login`, { method: 'POST', body: JSON.stringify({username: uIn.value, password: pIn.value}) });
        const d = await res.json(); if(d.success) { localStorage.setItem('ezUser', JSON.stringify(d.user)); showSelection(); } else alert("Errore");
    }
    async function showSelection() {
        const user = JSON.parse(localStorage.getItem('ezUser'));
        if(!user) return navigate('view-login'); navigate('view-selection');
        const res = await fetch(`${API}/user/companies?username=${user.username}`);
        const cos = await res.json();
        document.getElementById('list-companies').innerHTML = cos.map(c => `<button class="btn-grey" onclick="openDash('${c._id}','${c.name}','${c.inviteCode}')">${c.name}</button>`).join(' ');
    }
    function openDash(id, name, code) { currentId = id; document.getElementById('activeCoName').innerText = name; document.getElementById('activeCoCode').innerText = "Cod: "+code; navigate('view-dashboard'); switchTab('pos'); }
    async function addCat() { await fetch(`${API}/categorie?companyId=${currentId}`, { method: 'POST', body: JSON.stringify({nome: inCat.value}) }); inCat.value = ""; refresh(); }
    async function addProd() { await fetch(`${API}/prodotti?companyId=${currentId}`, { method: 'POST', body: JSON.stringify({nome: inPN.value, prezzo: inPP.value, categoria: selPC.value}) }); inPN.value = ""; inPP.value = ""; refresh(); }
    async function delItem(t, id) { if(confirm("Eliminare?")) { await fetch(`${API}/${t}?id=${id}&companyId=${currentId}`, { method: 'DELETE' }); refresh(); } }
    
    function editCatRow(id, name) {
        const row = document.getElementById(`row-cat-${id}`);
        row.innerHTML = `<td><input id="e-cn-${id}" value="${name}"></td><td style="text-align:right"><button class="btn-save" onclick="saveCat('${id}')">üíæ</button> <button class="btn-grey" onclick="refresh()">‚ùå</button></td>`;
    }
    async function saveCat(id) {
        await fetch(`${API}/categorie?id=${id}&companyId=${currentId}`, { method: 'PUT', body: JSON.stringify({nome: document.getElementById(`e-cn-${id}`).value}) }); refresh();
    }
    function editProdRow(id, name, price, cat) {
        const row = document.getElementById(`row-prod-${id}`);
        const opts = allCats.map(c => `<option value="${c.nome}" ${c.nome===cat?'selected':''}>${c.nome}</option>`).join('');
        row.innerHTML = `<td><input id="e-pn-${id}" value="${name}" style="margin-bottom:5px"><select id="e-pc-${id}">${opts}</select></td><td><input id="e-pp-${id}" value="${price}" type="number" style="width:70px">‚Ç¨</td><td style="text-align:right"><button class="btn-save" onclick="saveProd('${id}')">üíæ</button> <button class="btn-grey" onclick="refresh()">‚ùå</button></td>`;
    }
    async function saveProd(id) {
        await fetch(`${API}/prodotti?id=${id}&companyId=${currentId}`, { method: 'PUT', body: JSON.stringify({nome: document.getElementById(`e-pn-${id}`).value, prezzo: document.getElementById(`e-pp-${id}`).value, categoria: document.getElementById(`e-pc-${id}`).value}) }); refresh();
    }

    async function doCreateCo() { const u = JSON.parse(localStorage.getItem('ezUser')); await fetch(`${API}/azienda/crea`, { method: 'POST', body: JSON.stringify({companyName: newCo.value, ownerUsername: u.username}) }); newCo.value = ""; showSelection(); }
    async function doJoinCo() { const u = JSON.parse(localStorage.getItem('ezUser')); const res = await fetch(`${API}/azienda/unisciti`, { method: 'POST', body: JSON.stringify({inviteCode: joinCode.value, username: u.username}) }); if(res.ok) { joinCode.value = ""; showSelection(); } else alert("Codice errato"); }
    function doLogout() { localStorage.clear(); location.reload(); }
    if(localStorage.getItem('ezUser')) showSelection();

    // Mobile Cart Toggle
    function toggleCart() {
        document.getElementById('mobile-cart').classList.toggle('open');
    }
    
    function toggleReportFilters() {
        const body = document.getElementById('report-filters-body');
        const icon = document.querySelector('.filter-toggle-icon');
        if(window.innerWidth <= 768) { body.classList.toggle('open'); icon.classList.toggle('open'); }
    }

    // PWA Service Worker Registration
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW registered', reg)).catch(err => console.log('SW failed', err));
        });
    }
</script>
</body>
</html>